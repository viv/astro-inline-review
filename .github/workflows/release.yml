name: Release

on:
  push:
    tags:
      - 'v*'

# NOTE: Acceptance tests (Playwright E2E) run in the separate acceptance.yml
# workflow on push to main. Verify that acceptance tests pass on main before
# tagging a release. The acceptance tests require the external test suite repo
# (viv/review-loop-tests) which makes them impractical to duplicate here.

jobs:
  release:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: write       # GitHub Release creation
      id-token: write        # npm provenance attestation
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Upgrade npm (OIDC trusted publishing requires npm >= 11.5.1)
        run: npm install -g npm@latest

      - run: npm ci

      - run: npm run build

      - name: Run tests
        run: npm test

      - name: Validate version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Tag version: $TAG_VERSION"
          echo "package.json version: $PKG_VERSION"
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch — tag is v$TAG_VERSION but package.json has $PKG_VERSION"
            exit 1
          fi

      - name: Pack
        run: npm pack

      - uses: actions/upload-artifact@v7
        with:
          name: release-tarball-${{ github.ref_name }}
          path: "*.tgz"

      - name: Publish to npm
        run: npm publish --provenance --access public
        # Authentication via OIDC trusted publisher — no token needed.
        # Requires npm >= 11.5.1 (upgraded above) and id-token: write permission (already set).

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: "*.tgz"
